version: '3'

tasks:
  clean:
    desc: Remove broken symlinks from dotfiles and ~/.claude
    cmds:
      - |
        echo "Cleaning broken symlinks..."

        # Clean ~/.claude broken symlinks
        for dir in agents hooks rules skills commands templates; do
          link="{{.HOME_CLAUDE}}/$dir"
          if [ -L "$link" ] && [ ! -e "$link" ]; then
            rm -f "$link"
            echo "  - ~/.claude/$dir (broken)"
          fi
        done

        # Clean dotfiles broken symlinks
        find {{.DOTFILES_CLAUDE}}/agents -type l ! -exec test -e {} \; -delete 2>/dev/null || true
        find {{.DOTFILES_CLAUDE}}/hooks -type l ! -exec test -e {} \; -delete 2>/dev/null || true
        find {{.DOTFILES_CLAUDE}}/rules -type l ! -exec test -e {} \; -delete 2>/dev/null || true
        find {{.DOTFILES_CLAUDE_ONLY}} -maxdepth 1 -type l ! -exec test -e {} \; -delete 2>/dev/null || true
        find {{.DOTFILES_CLAUDE}}/skills -maxdepth 1 -type l ! -exec test -e {} \; -delete 2>/dev/null || true
        echo "Done"

  clean:all:
    desc: Remove all orchestra symlinks from dotfiles and ~/.claude (for restore)
    cmds:
      - |
        echo "Removing all orchestra symlinks..."

        # Remove ~/.claude directory symlinks
        echo "Cleaning ~/.claude symlinks..."
        for dir in agents hooks rules skills commands templates; do
          if [ -L "{{.HOME_CLAUDE}}/$dir" ]; then
            rm -f "{{.HOME_CLAUDE}}/$dir"
            echo "  - ~/.claude/$dir"
          fi
        done

        # Remove dotfiles symlinks (use find to catch all symlinks)
        echo "Cleaning dotfiles symlinks..."
        # agents - remove all symlinks
        find "{{.DOTFILES_CLAUDE}}/agents" -maxdepth 1 -type l -delete 2>/dev/null || true
        echo "  - dotfiles agents"
        # hooks - remove all symlinks
        find "{{.DOTFILES_CLAUDE}}/hooks" -maxdepth 1 -type l -delete 2>/dev/null || true
        echo "  - dotfiles hooks"
        # rules - remove all symlinks
        find "{{.DOTFILES_CLAUDE}}/rules" -maxdepth 1 -type l -delete 2>/dev/null || true
        echo "  - dotfiles rules"
        # skills - remove all symlinks (both locations)
        find "{{.DOTFILES_CLAUDE_ONLY}}" -maxdepth 1 -type l -delete 2>/dev/null || true
        find "{{.DOTFILES_CLAUDE}}/skills" -maxdepth 1 -type l -delete 2>/dev/null || true
        echo "  - dotfiles skills"
        # commands - remove all symlinks AND regular files (legacy cleanup)
        find "{{.DOTFILES_CLAUDE}}/commands" -maxdepth 1 -type l -delete 2>/dev/null || true
        find "{{.DOTFILES_CLAUDE}}/commands" -maxdepth 1 -type f -name "*.md" -delete 2>/dev/null || true
        echo "  - dotfiles commands"
        # templates - remove all symlinks
        find "{{.DOTFILES_CLAUDE}}/templates" -maxdepth 1 -type l -delete 2>/dev/null || true
        echo "  - dotfiles templates"
        echo "Done"

  restore:
    desc: Remove and recreate all orchestra symlinks (use after path changes)
    cmds:
      - task: clean:all
      - task: sync
